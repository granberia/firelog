---
title: RisuAI 프롬프트 조합 방식 분석
date: 2025-11-03 11:52:10 +0900
categories: [개발]
tags: [개발, 리서치, AI 채팅]
image:
  path: /img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-5.png
  alt: "alt text"
---


RisuAI에서 어떻게 LLM에게 프롬프트를 조합해서 전달하는지 확인해보자.

[https://github.com/kwaroran/RisuAI](https://github.com/kwaroran/RisuAI) 를 클론받고 Cursor에 질문을 던져보자.

LLM에게 최종적으로 어떤 프롬프트가 전달되었는지 로그를 남기는 곳이 있을까? 라고 물어본다면...

### Cursor AI의 결과물

<details markdown="1">
<summary>접기/펴기</summary>

```
프롬프트가 실제 전송 직전에 어디서 기록되는지 찾기 위해 요청 생성부와 템플릿 적용부 전역에서 로그/프리뷰 출력을 동시에 검색하겠습니다.

방금 최종 프롬프트 경로를 확인했습니다. 기본적으로 자동 로그는 남기지 않고, “프리뷰” 모드로 최종 payload를 확인하도록 되어 있습니다.

### 결론
- **자동 로그 없음**: 기본 실행 경로에서는 최종 프롬프트/바디를 파일이나 콘솔에 지속적으로 로그하지 않습니다.
- **프리뷰 기능 제공**:
  - `sendChat`에 `previewPrompt: true`를 주면, 전송 대신 프롬프트 바디를 반환하여 `previewBody`에 저장합니다.
  - 각 프로바이더 요청부는 `arg.previewBody`가 true일 때 실제 전송 대신 URL/Body/Headers를 JSON 문자열로 반환합니다.
  - 메시지 배열 자체를 보고 싶으면 `preview: true`로 `previewFormated`를 확인할 수 있습니다.

### 근거 코드
- 프리뷰 진입/결과 저장
```1463:1479:src/ts/process/index.svelte.ts
        previewBody: arg.previewPrompt,
...
    if(arg.previewPrompt && req.type === 'success'){
        previewBody = req.result
        return true
    }
```

- 메시지 배열 프리뷰
```1450:1453:src/ts/process/index.svelte.ts
    if(arg.preview){
        previewFormated = formated
        return true
    }
```

- OpenAI/OpenRouter: 프리뷰 시 최종 Body 반환
```321:327:src/ts/process/request/openAI.ts
    if(arg.previewBody){
        return {
            type: 'success',
            result: JSON.stringify({
                url: url.toString(),
                body: body,
                headers
            })
        }
    }
```

- Ooba(TextGen 등): 템플릿 적용 후 `prompt`와 `stop`을 포함한 Body 프리뷰
```932:941:src/ts/process/request/request.ts
    if(arg.previewBody){
        return {
            type: 'success',
            result: JSON.stringify({
                url: urlStr,
                body: bodyTemplate,
                headers: {}
            })      
        }
    }
```

원하시면 특정 모델 경로에서 항상 콘솔로 남기도록 한 줄 로그를 추가해 드릴 수 있어요.

</details>
<br>

프리뷰 모드가 활성화된 상태라면 어떤 요청이 오고 갔는지 확인할 수 있다고 한다.

채널에서 프리뷰와 관련된 검색 결과를 찾아봤더니 [https://arca.live/b/characterai/150849487](https://arca.live/b/characterai/150849487) 글에 프리뷰 모드를 포함한 유용한 팁들이 조금 있다.

설정 - 고급 설정 - 개발자 도구를 활성화하면 몇 가지 기능이 생기는데 하나씩 테스트해봐야겠군.

먼저 프롬프트 복잡도가 낮은 AI 봇을 사용해서 테스트해보자. Luna White Paws Velvet은 로어북 없이 설명만 존재하는 봇이다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-5.png)

이번 리서치를 도와줄 메스케모 되시겠다.

Preview Prompt에서 요청을 보내기 전 미리 확인해보았을 때 LLM에게 어떤 내용이 오고 가는지 볼 수 있는 것 같다.

보아하니 이 내용 중 탈옥을 위한 프롬프트도 들어있는 것 같아서 전체 내용을 붙여넣기에는 좀 그렇고, 덩어리 하나하나만 잘라서 이미지로 올려보자.

### AI 봇 프롬프트 구조 분석

<details markdown="1">
<summary>접기/펴기</summary>

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image.png)

덩어리 1. 마나젬 프리셋의 일부가 포함되어 있다.

설정 - 채팅 봇 - 프롬프트 탭에 정리된 순서대로 프롬프트들을 조립하는 것 같다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-1.png)

덩어리 2. Roles는 비워져 있고 설정에서 입력한 페르소나 정보가 포함되어 있다.

```
{{#if_pure {{all::{{less::{{getglobalvar::toggle_사칭}}::4}}::{{not_equal::{{getglobalvar::toggle_사칭}}::null}}}}}}{{#if_pure {{all::{{less::{{getglobalvar::toggle_사칭}}::3}}::{{not_equal::{{getglobalvar::toggle_사칭}}::null}}}}}}
{{user}}: A passive avatar that can only quote dialogue through the user’s meta-input. The narration of internal psychology is the user’s domain, so the World Manager must not encroach upon it.{{/if}}{{#if_pure {{? {{getglobalvar::toggle_사칭}}=3}}}}
{{user}}: The user's avatar participating in the roleplay.{{/if}}

{{slot}}

---{{/if}}
```

그 아래에는 AI 봇이 가진 프롬프트가 들어있는데, 설정상의 이 부분 같다.

```
{{char}}: The foundational sheet for the story (e.g. a character sheet, setting details). If {{char}} is a character, it is treated as an NPC. Initial goals may change as the story progresses.

{{slot}}
```

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-2.png)

덩어리 3. Dialogue History라는 건 이전 대화 내역인가? 설마 이전 대화 내역을 전부 프롬프트 안에 들고 있는 건가?

이건 대화량이 조금 쌓이면 어떻게 작동하나 봐야겠다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-3.png)

덩어리 4. Lore 라는 부분이 빈 공간으로 존재하고 마나젬의 프롬프트처럼 보이는 부분이 들어있다.

마찬가지로 프롬프트 탭에 포함된 프롬프트의 일부 같다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-4.png)

덩어리 5.

AI 봇에 설정된 첫 메시지가 표시되고 있다.

하나하나 보면서 덩어리 1 ~ 5로 나눴지만 깊게 분석할 필요 없이 환경 설정의 프롬프트 구조를 그대로 따라가는 것 같다.

이제 첫 메시지를 보내고 나서 내용이 어떻게 변하는지 확인해보자.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-6.png)

첫 메시지를 보내고 난 뒤 덩어리 3의 변형.

Dialogue History와 Current Conversation에 사용자가 입력한 한 줄이 추가된 걸 볼 수 있다.

Current Conversation이 무슨 의미인지는 알겠는데, 그럼 설마 저 Dialogue History에 이제까지의 모든 채팅 내역을 넣는 건가?

토큰 소모량이 장난이 아닐 것 같은데... 과거에 사용했던 채팅 내역의 프리뷰를 보니 최대 30개 정도까지 쌓이는 것 같다.

그렇지, 설마 모든 채팅을 다 쌓아놓을 리가 없지.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-7.png)

첫 메시지를 보내고 난 뒤 덩어리 4의 변형.

이번에 받은 응답이 포함된 걸 볼 수 있다. 메시지 로그가 쌓임에 따라 바뀌는 건 이 덩어리 3, 4 부분 같다.

그렇다면 나머지 프롬프트들은 어떻게 만들어지는 걸까? 마나젬 설정을 바꿔보자.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-8.png)

이렇게 누가 봐도 결과물이 크게 바뀌도록 설정을 바꾼 뒤 프리뷰에서 프롬프트들이 수정되는 곳을 살펴보자.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-9.png)

마나젬을 수정한 요청을 보낸뒤 덩어리 1의 변형. 마나젬에서 사칭 관련 옵션이 수정되며 저렇게 바뀐 부분이 잡힌 것 같다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-10.png)

마나젬을 수정한 요청을 보낸뒤 덩어리 3의 변형. 이 아래에서 바뀐 부분들이 더 있긴 한데, 마나젬을 통해 덩어리 1과 3이 바뀐다는 걸 알 수 있다.

</details>
<br>

가장 간단한 형태의 AI 봇을 사용할 때 전송되는 프롬프트 구조는 대략 이런 느낌이었다.

그럼 여기서 조금 더 복잡한 구조를 가진 에셋 봇을 사용한다면 어떻게 프롬프트가 만들어질까 확인해보자.

저번에 테스트용으로 사용했던 Merry Sisters 4.0을 그대로 사용해보면 되겠지.

### 에셋 봇 프롬프트 구조 분석

<details markdown="1">
<summary>접기/펴기</summary>

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image.png)

덩어리 1. 같은 내용이라 기존의 이미지를 그대로 붙여넣었다. 마나젬에 의해 준비된 프롬프트 부분.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-11.png)

덩어리 2. 설정에서 입력한 페르소나 정보 아래부터는 이 에셋 봇의 설정이 들어가 있다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-2.png)

덩어리 3. Dialogue History는 마찬가지로 텅 비어 있는 게 맞다.

여기서 채팅을 이어나가면 AI 봇과 비슷하게 30개까지 이전 채팅이 쌓여 다음 답변이 그럴싸하게 나오게 만들겠지.

이건 대화량이 조금 쌓이면 어떻게 작동하나 봐야겠다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-12.png)

덩어리 4. AI 봇의 덩어리 4와는 달리 Lore 부분에 무언가 이것저것 많이 붙었다.

나중에 에셋 봇 내용물을 뜯어서 분석하기 시작하면 무엇이 어디에 붙나 잘 찾아보자.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-13.png)

AI 봇의 덩어리의 4와 5 사이 무언가 많다.

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-14.png)

여기까지가 에셋 봇에서 새로 추가된 부분들인 듯. 

![alt text](/img/2025-11-03-RisuAI-프롬프트-조합-방식-분석/image-15.png)

그 다음 덩어리 5 부분을 마저 보면 이전 AI 봇과 달리 첫 프롬프트가 없고 그대로 끝나는 걸 볼 수 있다.

이건 봇 설정에 따라 프롬프트 유무로 갈리는 듯.

이제 여기서 채팅을 쓰기 시작하면 AI 봇에서처럼 이전 채팅들이 계속 쌓이는 것 같다.

</details>

두 가지 봇을 사용할 때 RisuAI에서 어떻게 프롬프트를 합치나 봤는데, 옵션에서 설정한 순서로 그대로 넣는다는 것 정도를 알았다.

프롬프트들을 합체하는 특별한 비법 같은 건 따로 없었다. 비법이랄 게 있다면 나도 앞으로 이 순서를 따라 쓰면 중간은 갈 거라는 거?

이제 에셋 봇 하나 정도만 구조를 뜯어보면서 살펴봐야겠다.
